<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sofia 2.0 - AI Chatbot</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Showdown library to render Markdown -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 1rem;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .chat-container::-webkit-scrollbar {
            display: none;
        }
        .message-bubble {
            max-width: 85%;
            padding: 0.75rem 1.25rem;
            border-radius: 1.5rem;
            margin-bottom: 0.75rem;
            word-wrap: break-word;
            line-height: 1.6;
            position: relative;
        }
        .user-message {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.5rem;
            width: fit-content;
        }
        .ai-message {
            background-color: #e5e7eb;
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 0.5rem;
            padding-bottom: 2.5rem; /* Space for action icons */
        }
        .ai-message-container {
             max-width: 85%;
             margin-right: auto;
             margin-bottom: 0.75rem;
        }
        .ai-message ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .ai-message li {
            margin-bottom: 0.25rem;
        }
        .ai-message strong, .ai-message b {
            font-weight: 600;
            color: #111827;
        }
        .system-message {
            background-color: #f87171;
            color: white;
            align-self: center;
            text-align: center;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
        }
        .floating-action-button {
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
        }
        .floating-action-button:hover {
            transform: scale(1.05);
        }
        .message-actions {
            position: absolute;
            bottom: 0.5rem;
            right: 0.75rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0.7;
        }
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
            padding: 0.25rem;
            border-radius: 9999px;
            transition: background-color 0.2s;
        }
        .action-btn:hover {
            background-color: #d1d5db;
        }
        /* Style for the auto-expanding textarea */
        #message-input {
            resize: none;
            overflow-y: hidden;
            max-height: 150px; /* Limit max height */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <header class="w-full flex justify-between items-center py-4 px-6 bg-white border-b border-gray-200 fixed top-0 left-0 right-0 z-10">
        <div class="flex items-center space-x-2">
            <span class="font-bold text-xl text-indigo-600">Sofia 2.0</span>
        </div>
    </header>

    <main class="flex-1 flex flex-col pt-20 pb-24 bg-white">
        <div id="welcome-message-container" class="flex-1 flex items-center justify-center p-4 text-center">
            <h1 class="text-4xl font-bold text-gray-800">Hello, User</h1>
        </div>
        <div id="chat-container" class="flex-1 flex-col overflow-y-auto w-full px-4 sm:px-6 hidden">
        </div>
    </main>

    <footer class="w-full flex justify-center py-4 px-4 sm:px-6 fixed bottom-0 left-0 right-0 bg-white">
        <div class="w-full max-w-3xl flex items-end bg-white rounded-3xl border border-gray-300 shadow-lg px-2 sm:px-4 py-2">
            <div class="flex items-center space-x-1 sm:space-x-2 mr-1 sm:mr-2">
                 <button id="file-upload-btn" class="p-2 text-gray-400 hover:text-gray-600 transition-colors floating-action-button flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                </button>
                <input type="file" id="file-input" class="hidden" accept="image/*,.pdf,.doc,.docx">
                <button id="search-btn" class="p-2 text-gray-400 hover:text-gray-600 transition-colors floating-action-button flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </button>
            </div>
            
            <textarea id="message-input" rows="1" placeholder="Ask Sofia 2.0...." class="flex-1 min-w-0 px-2 sm:px-4 py-2 bg-transparent focus:outline-none text-gray-700" aria-label="Ask AI Chatbot"></textarea>
            
            <button id="mic-btn" class="p-2 text-gray-400 hover:text-gray-600 transition-colors floating-action-button flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
            </button>
            
            <button id="send-btn" class="ml-1 sm:ml-2 p-2 bg-indigo-600 rounded-full text-white shadow-lg hover:bg-indigo-700 transition-colors floating-action-button flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
            </button>
        </div>
    </footer>

    <script type="module">
        const chatContainer = document.getElementById('chat-container');
        const welcomeMessageContainer = document.getElementById('welcome-message-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');
        const fileUploadBtn = document.getElementById('file-upload-btn');
        const fileInput = document.getElementById('file-input');
        const searchBtn = document.getElementById('search-btn');
        
        const markdownConverter = new showdown.Converter();

        function addMessage(text, sender) {
            if (sender === 'user') {
                const messageBubble = document.createElement('div');
                messageBubble.textContent = text;
                messageBubble.className = 'message-bubble user-message ml-auto';
                chatContainer.appendChild(messageBubble);
            } else if (sender === 'ai') {
                const aiMessageContainer = document.createElement('div');
                aiMessageContainer.className = 'ai-message-container';

                const messageBubble = document.createElement('div');
                messageBubble.className = 'message-bubble ai-message';
                const formattedHtml = markdownConverter.makeHtml(text);
                const contentDiv = document.createElement('div');
                contentDiv.innerHTML = formattedHtml;
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                actionsDiv.innerHTML = `
                    <button class="action-btn copy-btn" title="Copy text">
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM5 11a1 1 0 100 2h4a1 1 0 100-2H5z"/></svg>
                    </button>
                    <button class="action-btn" title="Good response">
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                    </button>
                    <button class="action-btn" title="Bad response">
                       <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>
                    </button>
                `;
                
                messageBubble.appendChild(contentDiv);
                messageBubble.appendChild(actionsDiv);
                aiMessageContainer.appendChild(messageBubble);
                chatContainer.appendChild(aiMessageContainer);

                actionsDiv.querySelector('.copy-btn').addEventListener('click', (e) => {
                    navigator.clipboard.writeText(text);
                    e.target.closest('button').innerHTML = 'Copied!';
                    setTimeout(() => {
                         e.target.closest('button').innerHTML = `<svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM5 11a1 1 0 100 2h4a1 1 0 100-2H5z"/></svg>`;
                    }, 1500);
                });

            } else if (sender === 'system') {
                const messageBubble = document.createElement('div');
                messageBubble.textContent = text;
                messageBubble.className = 'message-bubble system-message';
                chatContainer.appendChild(messageBubble);
            }
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        async function sendMessage(text, isVision = false, base64Image = null) {
            const messageText = text.trim();
            if (!messageText && !base64Image) return;

            if (welcomeMessageContainer.offsetParent) {
                welcomeMessageContainer.classList.add('hidden');
                chatContainer.classList.remove('hidden');
            }
            
            if(messageText) addMessage(messageText, 'user');
            messageInput.value = '';
            // Reset textarea height after sending
            messageInput.style.height = 'auto';

            const typingIndicatorContainer = document.createElement('div');
            typingIndicatorContainer.className = 'ai-message-container typing-indicator';
            const typingBubble = `<div class="message-bubble ai-message">Sofia is typing...</div>`;
            typingIndicatorContainer.innerHTML = typingBubble;
            chatContainer.appendChild(typingIndicatorContainer);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            const apiUrl = window.location.origin + '/chat';
            const payload = {
                text: messageText,
                model: 'gemini',
                apiKey: "AIzaSyDSVYwHKLSd_R4HOKDTW8dCY1eY9TvbnP4",
                isVision: isVision,
                image: base64Image,
                userId: 'user-' + Math.random().toString(36).substr(2, 9)
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                document.querySelector('.typing-indicator').remove();

                if (!response.ok) {
                    const errorText = await response.text();
                    try {
                        const errorData = JSON.parse(errorText);
                        throw new Error(errorData.error || `Server responded with status ${response.status}`);
                    } catch (e) {
                        throw new Error(`Server returned an unexpected response. Check backend logs.`);
                    }
                }

                const result = await response.json();
                addMessage(result.response, 'ai');

            } catch (error) {
                console.error('Error sending message:', error);
                const indicator = document.querySelector('.typing-indicator');
                if (indicator) indicator.remove();
                addMessage(`Sorry, something went wrong: ${error.message}`, 'system');
            }
        }
        
        sendBtn.addEventListener('click', () => sendMessage(messageInput.value));
        
        // --- This is the new logic for the input box ---
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            // Set height based on content, but don't exceed max-height
            let newHeight = messageInput.scrollHeight;
            messageInput.style.height = `${newHeight}px`;
            // Enable scroll if content exceeds max-height
            if (newHeight > 150) {
                 messageInput.style.overflowY = 'auto';
            } else {
                 messageInput.style.overflowY = 'hidden';
            }
        });
        
        messageInput.addEventListener('keydown', (e) => {
            // Send on Enter, but allow new line with Shift+Enter
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevent new line
                sendMessage(messageInput.value);
            }
        });


        fileUploadBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const base64Image = e.target.result.split(',')[1];
                const userPrompt = prompt("What would you like to know about this image?", "Describe this image");
                if(userPrompt) {
                   sendMessage(userPrompt, true, base64Image);
                }
            };
            reader.readAsDataURL(file);
        });
        
        searchBtn.addEventListener('click', () => {
             const promptText = "Please summarize this YouTube video: " + messageInput.value.trim();
            if (messageInput.value.trim()) {
                sendMessage(promptText);
            }
        });
        
        let recognition;
        try {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            
            recognition.onstart = () => micBtn.classList.add('text-red-500');
            recognition.onend = () => micBtn.classList.remove('text-red-500');
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                messageInput.value = transcript;
                sendMessage(transcript);
};
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                addMessage(`Speech recognition error: ${event.error}`, 'system');
            };
            micBtn.addEventListener('click', () => recognition.start());
        } catch (e) {
            micBtn.style.display = 'none';
            console.warn('Speech Recognition API is not supported in this browser.');
        }
    </script>
</body>
</html>

