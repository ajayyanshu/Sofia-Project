<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sofia 2.0 - AI Chatbot</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Showdown library to render Markdown -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 1rem;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .chat-container::-webkit-scrollbar {
            display: none;
        }
        .message-bubble {
            max-width: 85%;
            padding: 0.75rem 1.25rem;
            border-radius: 1.5rem;
            margin-bottom: 0.75rem;
            word-wrap: break-word;
            line-height: 1.6;
            position: relative;
        }
        .user-message {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.5rem;
            width: fit-content;
        }
        .ai-message {
            background-color: #e5e7eb;
            color: #1f2937;
            align-self: start;
            border-bottom-left-radius: 0.5rem;
            width: fit-content; 
        }
        .ai-typing-container {
             display: flex;
             align-items: flex-start;
             gap: 0.75rem;
             max-width: 85%;
             margin-right: auto;
             margin-bottom: 0.75rem;
             width: fit-content;
        }
        .ai-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background-color: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .ai-message ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .ai-message li { margin-bottom: 0.25rem; }
        .ai-message strong, .ai-message b { font-weight: 600; color: #111827; }
        
        .system-message {
            background-color: #f87171; color: white; align-self: center; text-align: center;
            font-size: 0.875rem; padding: 0.5rem 1rem;
        }
      
        #message-input, #message-input-mobile {
            resize: none; overflow-y: hidden; max-height: 150px; transition: all 0.2s ease-in-out;
            border: none; width: 100%; background: transparent;
        }
        #message-input:focus, #message-input-mobile:focus { outline: none; }
        
        #file-preview-container-desktop, #file-preview-container-mobile { display: flex; gap: 0.5rem; padding: 0.5rem 0.5rem 0 0.5rem; }
        .preview-item { position: relative; border-radius: 0.5rem; overflow: hidden; }
        .preview-item.image-preview { width: 80px; height: 80px; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }

        .preview-item.doc-preview {
            width: 80px;
            height: 80px;
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
        }
        .doc-preview span {
            font-size: 0.75rem;
            text-align: center;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .remove-preview-btn {
            position: absolute; top: 2px; right: 2px; width: 1.25rem; height: 1.25rem;
            background-color: rgba(0,0,0,0.5); color: white; border-radius: 50%;
            border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 0.75rem; line-height: 1;
        }
        .check-mark { display: none; }
        .menu-item.active .check-mark { display: block; }
        
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <header class="w-full flex justify-between items-center py-4 px-6 bg-white border-b border-gray-200 fixed top-0 left-0 right-0 z-10">
        <div class="flex items-center space-x-2">
             <button class="sm:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button>
            <span class="font-bold text-xl text-indigo-600">Sofia 2.0</span>
        </div>
    </header>

    <main class="flex-1 flex flex-col pt-20 pb-48 sm:pb-32 bg-white">
        <div id="welcome-message-container" class="flex-1 flex flex-col items-center justify-center p-4 text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-8">What can I help with?</h1>
        </div>
        <div id="chat-container" class="flex-1 flex-col overflow-y-auto w-full px-4 sm:px-6 hidden"></div>
    </main>

    <footer class="w-full flex justify-center py-2 px-2 sm:py-4 sm:px-6 fixed bottom-0 left-0 right-0 bg-transparent">
        <div class="w-full max-w-3xl flex flex-col">
             <!-- Mobile Input -->
             <div class="sm:hidden w-full">
                <div class="bg-white flex flex-col p-2 rounded-2xl shadow-lg border border-gray-200">
                    <div id="file-preview-container-mobile" class="px-2"></div>
                    <div class="flex items-center space-x-2">
                        <button id="add-btn-mobile" class="p-2 text-gray-500">
                            <svg class="h-7 w-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m-6-6h12" />
                            </svg>
                        </button>
                        <textarea id="message-input-mobile" rows="1" placeholder="Ask Sofia 2.0..." class="flex-1 bg-transparent focus:outline-none py-2" aria-label="Ask AI Chatbot"></textarea>
                         <div id="mic-voice-container-mobile" class="flex items-center">
                            <button id="mic-btn-mobile" class="p-2 text-gray-500"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></button>
                            <button id="voice-mode-btn-mobile" class="p-2 text-gray-100 bg-black rounded-full"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10v4M9 8v8M15 5v14M21 10v4"/></svg></button>
                        </div>
                        <button id="send-btn-mobile" class="hidden p-2 text-white bg-indigo-600 rounded-full"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 11l7-7 7 7M12 4v17" /></svg></button>
                    </div>
                </div>
            </div>
            <!-- Desktop Input -->
            <div class="hidden sm:flex flex-col bg-white rounded-3xl border border-gray-300 shadow-lg px-4 py-2">
                <div id="file-preview-container-desktop"></div>
                <textarea id="message-input" rows="1" placeholder="Ask Sofia 2.0..." class="flex-1 min-w-0 p-2 bg-transparent text-gray-700" aria-label="Ask AI Chatbot"></textarea>
                <div class="flex items-center mt-2">
                    <div class="flex items-center flex-1">
                        <div class="relative flex items-center">
                             <button id="add-btn" class="p-2 text-gray-500 hover:text-indigo-600 transition-colors rounded-full hover:bg-gray-100 focus:outline-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                            </button>
                        </div>
                        <div id="mode-tag-container" class="hidden items-center ml-2">
                             <div id="mode-tag" class="flex items-center pl-3 pr-2 py-1 space-x-1 text-blue-600 bg-blue-100 rounded-full font-medium text-sm flex-shrink-0">
                                 <span id="mode-tag-icon"></span>
                                 <span id="mode-tag-text"></span>
                                 <button id="remove-mode-tag-btn" class="text-blue-800 hover:text-blue-900">&times;</button>
                             </div>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div id="mic-voice-container" class="flex items-center">
                            <button id="mic-btn" class="p-2 text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></button>
                            <button id="voice-mode-btn" class="p-2 text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10v4M9 8v8M15 5v14M21 10v4"/></svg></button>
                        </div>
                        <button id="send-btn" class="hidden ml-2 p-2 bg-indigo-600 rounded-full text-white shadow-lg hover:bg-indigo-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 11l7-7 7 7M12 4v17" /></svg></button>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Action Menu -->
    <div id="action-menu" class="fixed bottom-24 sm:bottom-auto sm:top-1/2 sm:-translate-y-1/2 left-4 w-56 bg-white rounded-xl shadow-2xl border border-gray-100 z-20 hidden">
        <button id="menu-add-files-btn" class="w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 flex items-center space-x-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
            </svg>
            <span class="text-sm font-medium">Add photos & files</span>
        </button>
        <button class="menu-item w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 flex items-center justify-between" data-mode="image" data-placeholder="Create an image of..." data-tag-text="Image">
            <div class="flex items-center space-x-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><span class="text-sm font-medium">Create Image</span></div>
            <svg class="h-5 w-5 text-blue-600 check-mark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
        </button>
        <button class="menu-item w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 flex items-center justify-between" data-mode="web" data-placeholder="Search the web for..." data-tag-text="Web">
            <div class="flex items-center space-x-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9V3m0 18a9 9 0 009-9M3 12a9 9 0 019-9m-9 9h18" /></svg><span class="text-sm font-medium">Web Search</span></div>
            <svg class="h-5 w-5 text-blue-600 check-mark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
        </button>
    </div>
    <input type="file" id="file-input" class="hidden" accept="image/*,.pdf,.doc,.docx">

    <script type="module">
     document.addEventListener('DOMContentLoaded', () => {
        // Get all DOM elements
        const chatContainer = document.getElementById('chat-container');
        const welcomeMessageContainer = document.getElementById('welcome-message-container');
        const messageInput = document.getElementById('message-input');
        const messageInputMobile = document.getElementById('message-input-mobile');
        const sendBtn = document.getElementById('send-btn');
        const sendBtnMobile = document.getElementById('send-btn-mobile');
        const micBtn = document.getElementById('mic-btn');
        const micBtnMobile = document.getElementById('mic-btn-mobile');
        const fileInput = document.getElementById('file-input');
        const filePreviewContainerDesktop = document.getElementById('file-preview-container-desktop');
        const filePreviewContainerMobile = document.getElementById('file-preview-container-mobile');
        const addBtn = document.getElementById('add-btn');
        const addBtnMobile = document.getElementById('add-btn-mobile');
        const actionMenu = document.getElementById('action-menu');
        const micVoiceContainer = document.getElementById('mic-voice-container');
        const micVoiceContainerMobile = document.getElementById('mic-voice-container-mobile');
        const modeTagContainer = document.getElementById('mode-tag-container');
        const modeTagText = document.getElementById('mode-tag-text');
        const modeTagIcon = document.getElementById('mode-tag-icon');
        const removeModeTagBtn = document.getElementById('remove-mode-tag-btn');
        const menuAddFilesBtn = document.getElementById('menu-add-files-btn');
        const menuItems = document.querySelectorAll('.menu-item');
        
        const markdownConverter = new showdown.Converter();
        let stagedFile = null;
        const geminiApiKey = ""; // This should be left empty

        function getCurrentMessage() { return window.innerWidth < 640 ? messageInputMobile.value : messageInput.value; }
        function setCurrentMessage(val) {
            messageInput.value = val;
            messageInputMobile.value = val;
            messageInput.dispatchEvent(new Event('input'));
            messageInputMobile.dispatchEvent(new Event('input'));
        }

        // Add a message to the chat
        function addMessage(text, sender, fileInfo = null) {
            if (welcomeMessageContainer.offsetParent) {
                welcomeMessageContainer.classList.add('hidden');
                chatContainer.classList.remove('hidden');
            }
            if (sender === 'user') {
                const messageBubble = document.createElement('div');
                let fileHtml = '';
                if (fileInfo && fileInfo.type.startsWith('image/')) {
                     fileHtml = `<img src="${stagedFile.dataUrl}" alt="User upload" class="rounded-lg mb-2 max-w-xs">`;
                }
                messageBubble.innerHTML = fileHtml + `<div>${text}</div>`;
                messageBubble.className = 'message-bubble user-message ml-auto';
                chatContainer.appendChild(messageBubble);
            } else if (sender === 'ai') {
                const messageBubble = document.createElement('div');
                messageBubble.className = 'message-bubble ai-message';
                if (text.startsWith('data:image')) {
                    messageBubble.innerHTML = `<img src="${text}" alt="Generated by AI" class="rounded-lg max-w-full">`;
                } else {
                    const formattedHtml = markdownConverter.makeHtml(text);
                    messageBubble.innerHTML = formattedHtml;
                }
                chatContainer.appendChild(messageBubble);

            } else if (sender === 'system') {
                const messageBubble = document.createElement('div');
                messageBubble.textContent = text;
                messageBubble.className = 'message-bubble system-message';
                chatContainer.appendChild(messageBubble);
            }
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Show file preview
        function showFilePreview(file) {
            let previewHTML = '';
            if (file.type.startsWith('image/')) {
                previewHTML = `<div class="preview-item image-preview relative group">
                                <img src="${stagedFile.dataUrl}" alt="${file.name}" class="rounded-lg w-20 h-20 object-cover">
                                <button class="remove-preview-btn absolute top-1 right-1 bg-black bg-opacity-50 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>
                             </div>`;
            } else {
                 previewHTML = `<div class="preview-item doc-preview relative group">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <span class="text-xs text-gray-700 truncate w-20 text-center">${file.name}</span>
                                <button class="remove-preview-btn absolute top-1 right-1 bg-black bg-opacity-50 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>
                             </div>`;
            }

            filePreviewContainerDesktop.innerHTML = previewHTML;
            filePreviewContainerMobile.innerHTML = previewHTML;

            document.querySelectorAll('.remove-preview-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    stagedFile = null;
                    filePreviewContainerDesktop.innerHTML = '';
                    filePreviewContainerMobile.innerHTML = '';
                    fileInput.value = '';
                });
            });
        }
        
        // Call Gemini API
        async function callGeminiApi(prompt, mode, file = null) {
             const apiKey = geminiApiKey;
            let apiUrl, payload;

            if (mode === 'image') {
                apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                payload = { instances: [{ prompt }], parameters: { "sampleCount": 1 } };
            } else {
                apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                let parts = [{ text: prompt }];
                if (file && file.type.startsWith('image/')) {
                    parts.push({ inlineData: { mimeType: file.type, data: file.base64 } });
                }
                // Corrected payload with 'role'
                payload = { contents: [{ role: "user", parts: parts }] }; 
                if (mode === 'web') {
                    payload.tools = [{ "google_search": {} }];
                }
            }

            for (let i = 0, delay = 1000; i < 3; i++, delay *= 2) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                     if (response.status === 403) {
                         throw new Error('API key is invalid or missing. Please check your configuration.');
                    }
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error("API Error Response:", errorText);
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    
                    const result = await response.json();
                    if (mode === 'image') {
                        if (result.predictions?.[0]?.bytesBase64Encoded) {
                            return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                        }
                        throw new Error('Invalid image response from API');
                    } else {
                        if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                            return result.candidates[0].content.parts[0].text;
                        }
                        // Handle cases where the response might be blocked
                        if(result.candidates?.[0]?.finishReason === 'SAFETY') {
                            return "I'm sorry, but I can't respond to that. The request was blocked for safety reasons."
                        }
                        throw new Error('Invalid text response from API');
                    }
                } catch (error) {
                    if (i === 2) throw error;
                    await new Promise(res => setTimeout(res, delay));
                }
            }
        }

        // Send message logic
        async function sendMessage() {
            let messageText = getCurrentMessage().trim();
            if (!messageText && !stagedFile) return;

            const activeMode = document.querySelector('.menu-item.active')?.dataset.mode || 'chat';
            
            addMessage(messageText, 'user', stagedFile);
            
            const currentFile = stagedFile;
            stagedFile = null;
            setCurrentMessage('');
            filePreviewContainerDesktop.innerHTML = '';
            filePreviewContainerMobile.innerHTML = '';

            const typingIndicatorContainer = document.createElement('div');
            typingIndicatorContainer.className = 'ai-typing-container typing-indicator';
            typingIndicatorContainer.innerHTML = `<div class="ai-avatar"><svg class="h-6 w-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a5 5 0 00-5 5 5 5 0 005 5 5 5 0 005-5 5 5 0 00-5-5zM12 14a9 9 0 00-9 9h18a9 9 0 00-9-9z"/></svg></div><div class="message-bubble ai-message" style="padding-bottom: 0.75rem;">Sofia is thinking...</div>`;
            chatContainer.appendChild(typingIndicatorContainer);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                const responseText = await callGeminiApi(messageText, activeMode, currentFile);
                addMessage(responseText, 'ai');
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                addMessage(`Sorry, I encountered an error: ${error.message}. Please try again.`, 'system');
            } finally {
                document.querySelector('.typing-indicator')?.remove();
            }
        }
        
        // Event Listeners Setup
        sendBtn.addEventListener('click', sendMessage);
        sendBtnMobile.addEventListener('click', sendMessage);

        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = `${textarea.scrollHeight}px`;
        }
        
        [messageInput, messageInputMobile].forEach(input => {
            input.addEventListener('input', () => {
                adjustTextareaHeight(input);
                const hasText = input.value.trim().length > 0;
                
                micVoiceContainer.classList.toggle('hidden', hasText);
                sendBtn.classList.toggle('hidden', !hasText);
                micVoiceContainerMobile.classList.toggle('hidden', hasText);
                sendBtnMobile.classList.toggle('hidden', !hasText);
                if (input === messageInput) messageInputMobile.value = input.value;
                if (input === messageInputMobile) messageInput.value = input.value;
            });
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 4 * 1024 * 1024) {
                addMessage("Sorry, that file is too large. Please upload files under 4MB.", "system");
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                stagedFile = { base64: e.target.result.split(',')[1], dataUrl: e.target.result, name: file.name, type: file.type };
                showFilePreview(file);
            };
            reader.readAsDataURL(file);
            if (!actionMenu.classList.contains('hidden')) {
                toggleActionMenu();
            }
        });

        function toggleActionMenu() {
            actionMenu.classList.toggle('hidden');
        }
        
        addBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleActionMenu() });
        addBtnMobile.addEventListener('click', (e) => { e.stopPropagation(); toggleActionMenu() });
        
        document.addEventListener('click', (event) => {
            if (!actionMenu.classList.contains('hidden') && !actionMenu.contains(event.target) && !addBtn.contains(event.target) && !addBtnMobile.contains(event.target)) {
                actionMenu.classList.add('hidden');
            }
        });

        function setMode(target) {
            menuItems.forEach(item => item.classList.remove('active'));
            target.classList.add('active');
            
            const placeholder = target.dataset.placeholder;
            const tagText = target.dataset.tagText;
            const iconHTML = target.querySelector('.flex.items-center.space-x-3 svg').outerHTML;
            
            messageInput.placeholder = placeholder;
            messageInputMobile.placeholder = placeholder;

            modeTagContainer.classList.remove('hidden');
            modeTagText.textContent = tagText;
            modeTagIcon.innerHTML = iconHTML;
            
            if (!actionMenu.classList.contains('hidden')) {
                toggleActionMenu();
            }
            messageInput.focus();
        }

        menuItems.forEach(item => { item.addEventListener('click', (e) => setMode(e.currentTarget)); });
        removeModeTagBtn.addEventListener('click', () => {
            document.querySelector('.menu-item.active')?.classList.remove('active');
            modeTagContainer.classList.add('hidden');
            messageInput.placeholder = "Ask Sofia 2.0...";
        });
        
        if (menuAddFilesBtn) {
            menuAddFilesBtn.addEventListener('click', () => { fileInput.click(); });
        }
        
        // Voice Recognition
        let recognition;
        function setupRecognition() {
            if (!recognition) {
                try {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognition = new SpeechRecognition();
                    recognition.continuous = false;
                    recognition.lang = 'en-US';
                    recognition.onstart = () => [micBtn, micBtnMobile].forEach(b => b.classList.add('text-red-500'));
                    recognition.onend = () => [micBtn, micBtnMobile].forEach(b => b.classList.remove('text-red-500'));
                    recognition.onresult = (event) => {
                        setCurrentMessage(event.results[0][0].transcript);
                        sendMessage();
                    };
                    recognition.onerror = (event) => addMessage(`Speech recognition error: ${event.error}`, 'system');
                } catch (e) {
                    [micBtn, micBtnMobile].forEach(b => b.style.display = 'none');
                    console.warn('Speech Recognition not supported.');
                    return;
                }
            }
            recognition.start();
        }
        micBtn.addEventListener('click', setupRecognition);
        micBtnMobile.addEventListener('click', setupRecognition);
        
        // Set initial state
        modeTagContainer.classList.add('hidden');
        messageInput.placeholder = "Ask Sofia 2.0...";
        messageInputMobile.placeholder = "Ask Sofia 2.0...";
        
        messageInput.dispatchEvent(new Event('input'));
        messageInputMobile.dispatchEvent(new Event('input'));
    });
    </script>
</body>
</html>

