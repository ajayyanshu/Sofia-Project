<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sofia 2.0 - AI Chatbot</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Showdown library to render Markdown -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 1rem;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .chat-container::-webkit-scrollbar {
            display: none;
        }
        .message-bubble {
            max-width: 75%;
            padding: 0.75rem 1.25rem;
            border-radius: 1.5rem;
            margin-bottom: 0.75rem;
            word-wrap: break-word;
            line-height: 1.6;
        }
        .user-message {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.5rem;
            /* This is the fix: Makes the bubble only as wide as its content */
            width: fit-content;
        }
        .ai-message-container {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            max-width: 75%;
            margin-right: auto;
            margin-bottom: 0.75rem;
        }
        .ai-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background-color: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .ai-message {
            background-color: #e5e7eb;
            color: #1f2937;
            border-bottom-left-radius: 0.5rem;
        }
        /* Styling for lists and bold text rendered from Markdown */
        .ai-message ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .ai-message li {
            margin-bottom: 0.25rem;
        }
        .ai-message strong, .ai-message b {
            font-weight: 600;
            color: #111827;
        }
        .system-message {
            background-color: #f87171; /* A slightly different red for system errors */
            color: white;
            align-self: center;
            text-align: center;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
        }
        .floating-action-button {
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
        }
        .floating-action-button:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <header class="w-full flex justify-between items-center py-4 px-6 bg-white border-b border-gray-200 fixed top-0 left-0 right-0 z-10">
        <div class="flex items-center space-x-2">
            <span class="font-bold text-xl text-indigo-600">Sofia 2.0</span>
        </div>
    </header>

    <main class="flex-1 flex flex-col pt-20 pb-24 bg-white">
        <div id="welcome-message-container" class="flex-1 flex items-center justify-center p-4 text-center">
            <h1 class="text-4xl font-bold text-gray-800">Hello, User</h1>
        </div>
        <div id="chat-container" class="flex-1 flex-col overflow-y-auto w-full px-4 sm:px-6 hidden">
        </div>
    </main>

    <footer class="w-full flex justify-center py-4 px-4 sm:px-6 fixed bottom-0 left-0 right-0 bg-white">
        <div class="w-full max-w-3xl flex items-center bg-white rounded-3xl border border-gray-300 shadow-lg px-4 py-2">
            <div class="flex space-x-2 mr-2">
                 <button id="file-upload-btn" class="p-2 text-gray-400 hover:text-gray-600 transition-colors floating-action-button" aria-label="Upload file">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                </button>
                <input type="file" id="file-input" class="hidden" accept="image/*,.pdf,.doc,.docx">
                <button id="search-btn" class="p-2 text-gray-400 hover:text-gray-600 transition-colors floating-action-button" aria-label="Live search">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </button>
            </div>
            
            <input id="message-input" type="text" placeholder="Ask Sofia 2.0...." class="flex-1 px-4 py-2 bg-transparent focus:outline-none text-gray-700" aria-label="Ask AI Chatbot">
            
            <button id="mic-btn" class="p-2 text-gray-400 hover:text-gray-600 transition-colors floating-action-button" aria-label="Start voice input">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
            </button>
            
            <button id="send-btn" class="ml-2 p-2 bg-indigo-600 rounded-full text-white shadow-lg hover:bg-indigo-700 transition-colors floating-action-button" aria-label="Send message">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-45 -mt-1 -ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
            </button>
        </div>
    </footer>

    <script type="module">
        const chatContainer = document.getElementById('chat-container');
        const welcomeMessageContainer = document.getElementById('welcome-message-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');
        const fileUploadBtn = document.getElementById('file-upload-btn');
        const fileInput = document.getElementById('file-input');
        const searchBtn = document.getElementById('search-btn');
        
        // Initialize Showdown converter
        const markdownConverter = new showdown.Converter();

        function addMessage(text, sender) {
            if (sender === 'user') {
                const messageBubble = document.createElement('div');
                messageBubble.textContent = text;
                messageBubble.className = 'message-bubble user-message ml-auto';
                chatContainer.appendChild(messageBubble);
            } else if (sender === 'ai') {
                const aiMessageContainer = document.createElement('div');
                aiMessageContainer.className = 'ai-message-container';

                // AI Avatar
                const avatar = document.createElement('div');
                avatar.className = 'ai-avatar';
                avatar.innerHTML = `<svg class="h-6 w-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a5 5 0 00-5 5 5 5 0 005 5 5 5 0 005-5 5 5 0 00-5-5zM12 14a9 9 0 00-9 9h18a9 9 0 00-9-9z"/></svg>`;
                
                const messageBubble = document.createElement('div');
                // Convert Markdown to HTML before displaying
                const formattedHtml = markdownConverter.makeHtml(text);
                messageBubble.innerHTML = formattedHtml;
                messageBubble.className = 'message-bubble ai-message';

                aiMessageContainer.appendChild(avatar);
                aiMessageContainer.appendChild(messageBubble);
                chatContainer.appendChild(aiMessageContainer);
            } else if (sender === 'system') {
                const messageBubble = document.createElement('div');
                messageBubble.textContent = text;
                messageBubble.className = 'message-bubble system-message';
                chatContainer.appendChild(messageBubble);
            }
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        async function sendMessage(text, isVision = false, base64Image = null) {
            const messageText = text.trim();
            if (!messageText && !base64Image) return;

            if (welcomeMessageContainer.offsetParent) {
                welcomeMessageContainer.classList.add('hidden');
                chatContainer.classList.remove('hidden');
            }
            
            if(messageText) addMessage(messageText, 'user');
            messageInput.value = '';

            const typingIndicatorContainer = document.createElement('div');
            typingIndicatorContainer.className = 'ai-message-container typing-indicator';
            const avatar = `<div class="ai-avatar"><svg class="h-6 w-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a5 5 0 00-5 5 5 5 0 005 5 5 5 0 005-5 5 5 0 00-5-5zM12 14a9 9 0 00-9 9h18a9 9 0 00-9-9z"/></svg></div>`;
            const typingBubble = `<div class="message-bubble ai-message">Sofia is typing...</div>`;
            typingIndicatorContainer.innerHTML = avatar + typingBubble;
            chatContainer.appendChild(typingIndicatorContainer);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            const apiUrl = window.location.origin + '/chat';
            const payload = {
                text: messageText,
                model: 'gemini',
                // This is the fix for the JSON error
                apiKey: "AIzaSyDSVYwHKLSd_R4HOKDTW8dCY1eY9TvbnP4", 
                isVision: isVision,
                image: base64Image,
                userId: 'user-' + Math.random().toString(36).substr(2, 9)
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                document.querySelector('.typing-indicator').remove();

                if (!response.ok) {
                    // Try to get text error first, as it might be HTML
                    const errorText = await response.text();
                    try {
                        // See if it's actually JSON
                        const errorData = JSON.parse(errorText);
                        throw new Error(errorData.error || `Server responded with status ${response.status}`);
                    } catch (e) {
                        // If parsing fails, it's likely an HTML error page
                        throw new Error(`Server returned an unexpected response. Please check the backend logs.`);
                    }
                }

                const result = await response.json();
                addMessage(result.response, 'ai');

            } catch (error) {
                console.error('Error sending message:', error);
                // Make sure typing indicator is removed even if it was already
                const indicator = document.querySelector('.typing-indicator');
                if (indicator) indicator.remove();
                addMessage(`Sorry, something went wrong: ${error.message}`, 'system');
            }
        }
        
        sendBtn.addEventListener('click', () => sendMessage(messageInput.value));
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage(messageInput.value);
        });

        fileUploadBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const base64Image = e.target.result.split(',')[1];
                const userPrompt = prompt("What would you like to know about this image?", "Describe this image");
                if(userPrompt) {
                   sendMessage(userPrompt, true, base64Image);
                }
            };
            reader.readAsDataURL(file);
        });
        
        searchBtn.addEventListener('click', () => {
             const promptText = "Please summarize this YouTube video: " + messageInput.value.trim();
            if (messageInput.value.trim()) {
                sendMessage(promptText);
            }
        });
        
        let recognition;
        try {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            
            recognition.onstart = () => {
                micBtn.classList.add('text-red-500');
            };
            recognition.onend = () => {
                micBtn.classList.remove('text-red-500');
            };
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                messageInput.value = transcript;
                sendMessage(transcript);
            };
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                addMessage(`Speech recognition error: ${event.error}`, 'system');
            };
            micBtn.addEventListener('click', () => recognition.start());
        } catch (e) {
            micBtn.style.display = 'none';
            console.warn('Speech Recognition API is not supported in this browser.');
        }
    </script>
</body>
</html>

