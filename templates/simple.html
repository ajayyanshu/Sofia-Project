<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sofia 2.0 - AI Chatbot</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Showdown library to render Markdown -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 1rem;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .chat-container::-webkit-scrollbar {
            display: none;
        }
        .message-bubble {
            max-width: 85%;
            padding: 0.75rem 1.25rem;
            border-radius: 1.5rem;
            margin-bottom: 0.75rem;
            word-wrap: break-word;
            line-height: 1.6;
            position: relative;
        }
        .user-message {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.5rem;
            width: fit-content;
        }
        .ai-message {
            background-color: #e5e7eb;
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 0.5rem;
            padding-bottom: 2.5rem; /* Space for action icons */
            width: fit-content; 
        }
        .ai-typing-container {
             display: flex;
             align-items: flex-start;
             gap: 0.75rem;
             max-width: 85%;
             margin-right: auto;
             margin-bottom: 0.75rem;
             width: fit-content;
        }
        .ai-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background-color: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .ai-message ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .ai-message li {
            margin-bottom: 0.25rem;
        }
        .ai-message strong, .ai-message b {
            font-weight: 600;
            color: #111827;
        }
        .system-message {
            background-color: #f87171;
            color: white;
            align-self: center;
            text-align: center;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
        }
        .floating-action-button {
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
        }
        .floating-action-button:hover {
            transform: scale(1.05);
        }
        .message-actions {
            position: absolute;
            bottom: 0.5rem;
            right: 0.75rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0.7;
        }
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
            padding: 0.25rem;
            border-radius: 9999px;
            transition: background-color 0.2s;
        }
        .action-btn:hover {
            background-color: #d1d5db;
        }
        #message-input {
            resize: none;
            overflow-y: hidden;
            max-height: 150px;
            transition: all 0.2s ease-in-out;
            border: none;
            width: 100%;
            padding: 0.5rem;
        }
        #message-input:focus {
            outline: none;
        }
        #file-preview-container {
            padding: 0.5rem 0.5rem 0 0.5rem;
            display: flex;
            gap: 0.5rem;
        }
        .preview-item {
            position: relative;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        .preview-item.image-preview {
            width: 70px;
            height: 70px;
        }
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .preview-item.doc-preview {
             display: flex;
             align-items: center;
             padding: 0.5rem 0.75rem;
             background-color: #f3f4f6;
        }
        .doc-preview .file-icon {
            flex-shrink: 0;
            margin-right: 0.5rem;
        }
        .doc-preview .file-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.875rem;
            color: #4b5563;
        }
        .remove-preview-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 1.25rem;
            height: 1.25rem;
            background-color: rgba(0,0,0,0.5);
            color: white;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            line-height: 1;
        }

        /* Submenu styles */
        .submenu {
            display: none;
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            width: 200px;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #f3f4f6;
            z-index: 30;
        }
        .has-submenu:hover .submenu {
            display: block;
        }
        .check-mark {
            display: none;
        }
        .menu-item.active .check-mark {
            display: block;
        }
        
        @media (max-width: 640px) {
            #action-menu {
                left: 0;
                width: 100vw;
                bottom: 100%;
                border-radius: 1.5rem 1.5rem 0 0;
            }
             #welcome-message-container h1 {
                font-size: 2rem;
            }
             .footer-inner {
                padding: 0.5rem;
                flex-direction: column;
            }
            .input-area-wrapper {
                flex-direction: row;
                align-items: center;
                width: 100%;
            }
            #message-input {
                padding-left: 0;
                padding-right: 0.5rem;
            }
            .suggestion-chips {
                padding: 0.75rem 0.5rem 0.5rem;
                justify-content: center;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <header class="w-full flex justify-between items-center py-4 px-6 bg-white border-b border-gray-200 fixed top-0 left-0 right-0 z-10">
        <div class="flex items-center space-x-2">
             <button class="sm:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button>
            <span class="font-bold text-xl text-indigo-600">Sofia 2.0</span>
        </div>
    </header>

    <main class="flex-1 flex flex-col pt-20 pb-48 sm:pb-32 bg-white">
        <div id="welcome-message-container" class="flex-1 flex flex-col items-center justify-center p-4 text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-8">What can I help with?</h1>
            <div class="suggestion-chips flex flex-wrap gap-3">
            </div>
        </div>
        <div id="chat-container" class="flex-1 flex-col overflow-y-auto w-full px-4 sm:px-6 hidden">
        </div>
    </main>

    <footer class="w-full flex justify-center py-4 px-4 sm:px-6 fixed bottom-0 left-0 right-0 bg-white sm:bg-transparent">
        <div class="w-full max-w-3xl flex flex-col bg-white rounded-3xl border border-gray-300 shadow-lg footer-inner">
            <div id="file-preview-container"></div>
            <div class="w-full flex flex-col px-2 sm:px-4 py-2">
                <textarea id="message-input" rows="1" placeholder="Ask anything" class="flex-1 min-w-0 bg-transparent text-gray-700" aria-label="Ask AI Chatbot"></textarea>
                <div class="flex items-center mt-2 sm:hidden">
                    <div class="flex items-center flex-1">
                        <div class="relative flex items-center">
                            <button id="add-btn-mobile" class="p-2 text-gray-500 hover:text-indigo-600 transition-colors rounded-full hover:bg-gray-100 focus:outline-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                     <div class="flex items-center">
                        <input type="file" id="file-input" class="hidden" accept="image/*,.pdf,.doc,.docx">
                        <div id="mic-voice-container-mobile" class="flex items-center">
                            <button id="mic-btn-mobile" class="p-2 text-gray-400 hover:text-gray-600 transition-colors floating-action-button flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                            </button>
                            <button id="voice-mode-btn-mobile" class="p-2 text-gray-400 hover:text-gray-600 transition-colors floating-action-button flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10v4M9 8v8M15 5v14M21 10v4"/></svg>
                            </button>
                        </div>
                        <button id="send-btn-mobile" class="hidden ml-1 sm:ml-2 p-2 bg-indigo-600 rounded-full text-white shadow-lg hover:bg-indigo-700 transition-colors floating-action-button flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 11l7-7 7 7M12 4v17" /></svg>
                        </button>
                    </div>
                </div>
                <div class="hidden sm:flex items-center mt-2">
                    <div class="flex items-center flex-1">
                        <div class="relative flex items-center">
                            <div id="action-menu" class="absolute bottom-12 -left-2 w-56 bg-white rounded-xl shadow-2xl border border-gray-100 hidden transition-all duration-300 ease-in-out transform origin-bottom-left z-20">
                                 <div class="grid grid-cols-3 gap-2 p-3 sm:hidden">
                                    <button class="flex flex-col items-center justify-center p-2 rounded-lg hover:bg-gray-100"><svg class="h-6 w-6 mb-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span class="text-xs">Camera</span></button>
                                    <button class="flex flex-col items-center justify-center p-2 rounded-lg hover:bg-gray-100"><svg class="h-6 w-6 mb-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><span class="text-xs">Photos</span></button>
                                    <button id="menu-add-files-btn" class="flex flex-col items-center justify-center p-2 rounded-lg hover:bg-gray-100"><svg class="h-6 w-6 mb-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg><span class="text-xs">Files</span></button>
                                </div>
                                <hr class="sm:hidden">
                                <button class="menu-item w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 flex items-center justify-between" data-mode="think" data-placeholder="Let's think about..." data-tag-text="Think">
                                    <div class="flex items-center space-x-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.75-1-2.414l-.548-.547z" />
                                        </svg>
                                        <span class="text-sm font-medium">Think longer</span>
                                    </div>
                                </button>
                                 <button class="menu-item w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 flex items-center justify-between active" data-mode="research" data-placeholder="Get a detailed report on..." data-tag-text="Research">
                                    <div class="flex items-center space-x-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-2.236 9.168-5.514C18.33 1.885 18.658 1.5 19 1.5s.67.385.832.486l.004.003.018.01a.5.5 0 01.04.062l.003.004a.5.5 0 01.018.033L20 2.13l.004.004a.5.5 0 01.02.042l.002.003a.5.5 0 01.016.037l.002.004a.5.5 0 01.01.03l.002.004c.003.01.006.02.007.031l.002.004a.5.5 0 01.004.022l.003.005a.5.5 0 01.002.02l.002.004a.5.5 0 01.003.023l.002.004a.5.5 0 01.002.023l.002.003a.5.5 0 01.002.024l.002.004a.5.5 0 01.002.025l.002.003a.5.5 0 01.002.026l.002.004a.5.5 0 01.002.028l.002.003a.5.5 0 01.002.03l.002.003a.5.5 0 01.002.034l.002.002a.5.5 0 01.002.036l.003.003a.5.5 0 01.002.04l.002.002a.5.5 0 01.002.045V4.5" />
                                        </svg>
                                        <span class="text-sm font-medium">Deep Research</span>
                                    </div>
                                 </button>
                                 <button class="menu-item w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 flex items-center justify-between" data-mode="study" data-placeholder="What should we study?" data-tag-text="Study">
                                    <div class="flex items-center space-x-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                        </svg>
                                        <span class="text-sm font-medium">Study and learn</span>
                                    </div>
                                 </button>
                                 <button class="menu-item w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 flex items-center justify-between" data-mode="image" data-placeholder="Create an image of..." data-tag-text="Image">
                                    <div class="flex items-center space-x-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                        <span class="text-sm font-medium">Create Image</span>
                                    </div>
                                 </button>
                                 <button class="menu-item w-full text-left px-4 py-3 text-gray-700 hover:bg-gray-100 flex items-center justify-between" data-mode="web" data-placeholder="Search the web for..." data-tag-text="Web">
                                     <div class="flex items-center space-x-3">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                             <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9V3m0 18a9 9 0 009-9M3 12a9 9 0 019-9m-9 9h18" />
                                         </svg>
                                         <span class="text-sm font-medium">Web Search</span>
                                     </div>
                                 </button>
                            </div>
                            <button id="add-btn" class="p-2 text-gray-500 hover:text-indigo-600 transition-colors rounded-full hover:bg-gray-100 focus:outline-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                            </button>
                        </div>
                        <div id="mode-tag-container" class="hidden items-center ml-2">
                             <div id="mode-tag" class="flex items-center pl-3 pr-2 py-1 space-x-1 text-blue-600 bg-blue-100 rounded-full font-medium text-sm flex-shrink-0">
                                 <span id="mode-tag-icon"></span>
                                 <span id="mode-tag-text"></span>
                                 <button id="remove-mode-tag-btn" class="text-blue-800 hover:text-blue-900">&times;</button>
                             </div>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div id="mic-voice-container" class="flex items-center">
                            <button id="mic-btn" class="p-2 text-gray-400 hover:text-gray-600 transition-colors floating-action-button flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                            </button>
                            <button id="voice-mode-btn" class="p-2 text-gray-400 hover:text-gray-600 transition-colors floating-action-button flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10v4M9 8v8M15 5v14M21 10v4"/></svg>
                            </button>
                        </div>
                        <button id="send-btn" class="hidden ml-1 sm:ml-2 p-2 bg-indigo-600 rounded-full text-white shadow-lg hover:bg-indigo-700 transition-colors floating-action-button flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 11l7-7 7 7M12 4v17" /></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script type="module">
        const chatContainer = document.getElementById('chat-container');
        const welcomeMessageContainer = document.getElementById('welcome-message-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const sendBtnMobile = document.getElementById('send-btn-mobile');
        const micBtn = document.getElementById('mic-btn');
        const micBtnMobile = document.getElementById('mic-btn-mobile');
        const fileInput = document.getElementById('file-input');
        const filePreviewContainer = document.getElementById('file-preview-container');
        const addBtn = document.getElementById('add-btn');
        const addBtnMobile = document.getElementById('add-btn-mobile');
        const actionMenu = document.getElementById('action-menu');
        const voiceModeBtn = document.getElementById('voice-mode-btn');
        const voiceModeBtnMobile = document.getElementById('voice-mode-btn-mobile');
        const micVoiceContainer = document.getElementById('mic-voice-container');
        const micVoiceContainerMobile = document.getElementById('mic-voice-container-mobile');
        
        const modeTagContainer = document.getElementById('mode-tag-container');
        const modeTag = document.getElementById('mode-tag');
        const modeTagText = document.getElementById('mode-tag-text');
        const modeTagIcon = document.getElementById('mode-tag-icon');
        const removeModeTagBtn = document.getElementById('remove-mode-tag-btn');
        const menuAddFilesBtn = document.getElementById('menu-add-files-btn');
        const menuItems = document.querySelectorAll('.menu-item');
        
        const markdownConverter = new showdown.Converter();
        let stagedFile = null;

        function addMessage(text, sender, fileInfo = null) {
            if (welcomeMessageContainer.offsetParent) {
                welcomeMessageContainer.classList.add('hidden');
                chatContainer.classList.remove('hidden');
            }
            if (sender === 'user') {
                const messageBubble = document.createElement('div');
                let fileHtml = '';
                if (fileInfo && fileInfo.type.startsWith('image/')) {
                     fileHtml = `<img src="${fileInfo.dataUrl}" alt="User upload" class="rounded-lg mb-2 max-w-xs">`;
                }
                messageBubble.innerHTML = fileHtml + `<div>${text}</div>`;
                messageBubble.className = 'message-bubble user-message ml-auto';
                chatContainer.appendChild(messageBubble);
            } else if (sender === 'ai') {
                const messageBubble = document.createElement('div');
                messageBubble.className = 'message-bubble ai-message ml-0';
                if (text.startsWith('data:image')) {
                    messageBubble.innerHTML = `<img src="${text}" alt="Generated by AI" class="rounded-lg max-w-full">`;
                } else {
                    const formattedHtml = markdownConverter.makeHtml(text);
                    const contentDiv = document.createElement('div');
                    contentDiv.innerHTML = formattedHtml;
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'message-actions';
                    actionsDiv.innerHTML = `
                        <button class="action-btn copy-btn" title="Copy text"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM5 11a1 1 0 100 2h4a1 1 0 100-2H5z"/></svg></button>
                        <button class="action-btn" title="Good response"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg></button>
                        <button class="action-btn" title="Bad response"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg></button>
                    `;
                    messageBubble.appendChild(contentDiv);
                    messageBubble.appendChild(actionsDiv);
                    
                    actionsDiv.querySelector('.copy-btn').addEventListener('click', (e) => {
                       try {
                           const tempInput = document.createElement('textarea');
                           tempInput.value = text;
                           document.body.appendChild(tempInput);
                           tempInput.select();
                           document.execCommand('copy');
                           document.body.removeChild(tempInput);
                           e.target.closest('button').innerHTML = 'Copied!';
                       } catch(e){
                           console.error("Copy failed", e)
                       }
                        setTimeout(() => {
                             e.target.closest('button').innerHTML = `<svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM5 11a1 1 0 100 2h4a1 1 0 100-2H5z"/></svg>`;
                        }, 1500);
                    });
                }
                chatContainer.appendChild(messageBubble);

            } else if (sender === 'system') {
                const messageBubble = document.createElement('div');
                messageBubble.textContent = text;
                messageBubble.className = 'message-bubble system-message';
                chatContainer.appendChild(messageBubble);
            }
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function showFilePreview(file) {
            filePreviewContainer.innerHTML = '';
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            
            if (file.type.startsWith('image/')) {
                 previewItem.classList.add('image-preview');
                 previewItem.innerHTML = `<img src="${stagedFile.dataUrl}" alt="${file.name}"><button class="remove-preview-btn">&times;</button>`;
            } else {
                 previewItem.classList.add('doc-preview');
                 previewItem.innerHTML = `
                    <div class="file-icon"><svg class="h-6 w-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></div>
                    <span class="file-name">${file.name}</span>
                    <button class="remove-preview-btn">&times;</button>
                 `;
            }
            filePreviewContainer.appendChild(previewItem);
            previewItem.querySelector('.remove-preview-btn').addEventListener('click', () => {
                stagedFile = null;
                filePreviewContainer.innerHTML = '';
                fileInput.value = '';
            });
        }
        
        async function callGeminiApi(prompt, mode, file = null) {
            const apiKey = ""; 
            let apiUrl = '';
            let payload = {};

            if (mode === 'image') {
                apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };
            } else {
                apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                let parts = [{ text: prompt }];
                if (file && file.type.startsWith('image/')) {
                    parts.push({ inlineData: { mimeType: file.type, data: file.base64 } });
                }
                
                payload = { contents: [{ parts: parts }] };

                if (mode === 'research') {
                    payload.tools = [{ "google_search": {} }];
                }
            }

            let response;
            let result;
            let retries = 3;
            let delay = 1000;

            for (let i = 0; i < retries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        result = await response.json();
                        if (mode === 'image') {
                            if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                                return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                            } else {
                                throw new Error('Invalid image response from API');
                            }
                        } else {
                             if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts.length > 0) {
                                return result.candidates[0].content.parts[0].text;
                            } else {
                                 throw new Error('Invalid text response from API');
                            }
                        }
                    } else {
                         throw new Error(`API request failed with status ${response.status}`);
                    }
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
        }

        async function sendMessage() {
            let messageText = messageInput.value.trim();
            if (!messageText && !stagedFile) return;

            const activeModeItem = document.querySelector('.menu-item.active');
            const activeMode = activeModeItem ? activeModeItem.dataset.mode : 'chat';
            
            addMessage(messageText, 'user', stagedFile);
            
            const currentFile = stagedFile;
            stagedFile = null;
            messageInput.value = '';
            messageInput.style.height = 'auto';
            messageInput.dispatchEvent(new Event('input')); 
            filePreviewContainer.innerHTML = '';

            const typingIndicatorContainer = document.createElement('div');
            typingIndicatorContainer.className = 'ai-typing-container typing-indicator';
            const avatar = `<div class="ai-avatar"><svg class="h-6 w-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a5 5 0 00-5 5 5 5 0 005 5 5 5 0 005-5 5 5 0 00-5-5zM12 14a9 9 0 00-9 9h18a9 9 0 00-9-9z"/></svg></div>`;
            const typingBubble = `<div class="message-bubble ai-message" style="padding-bottom: 0.75rem;">Sofia is thinking...</div>`;
            typingIndicatorContainer.innerHTML = avatar + typingBubble;
            chatContainer.appendChild(typingIndicatorContainer);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                const responseText = await callGeminiApi(messageText, activeMode, currentFile);
                addMessage(responseText, 'ai');
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                addMessage(`Sorry, I encountered an error: ${error.message}. Please try again.`, 'system');
            } finally {
                 const indicator = document.querySelector('.typing-indicator');
                if (indicator) indicator.remove();
            }
        }
        
        sendBtn.addEventListener('click', sendMessage);
        sendBtnMobile.addEventListener('click', sendMessage);

        function adjustTextareaHeight() {
            messageInput.style.height = 'auto';
            let newHeight = messageInput.scrollHeight;
            messageInput.style.height = `${newHeight}px`;
            if (newHeight > 150) {
                messageInput.style.overflowY = 'auto';
            } else {
                messageInput.style.overflowY = 'hidden';
            }
        }
        
        messageInput.addEventListener('input', () => {
            adjustTextareaHeight();
            const hasText = messageInput.value.trim().length > 0;

            micVoiceContainer.classList.toggle('hidden', hasText);
            sendBtn.classList.toggle('hidden', !hasText);
            micVoiceContainerMobile.classList.toggle('hidden', hasText);
            sendBtnMobile.classList.toggle('hidden', !hasText);
        });
        
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

             if (file.size > 4 * 1024 * 1024) { // 4MB limit for inline data
                addMessage("Sorry, that file is too large. Please upload files under 4MB.", "system");
                fileInput.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                stagedFile = {
                    base64: e.target.result.split(',')[1],
                    dataUrl: e.target.result,
                    name: file.name,
                    type: file.type
                };
                showFilePreview(file);
            };
            reader.readAsDataURL(file);
        });
        
        function updateAddButtonIcon() {
            const icon = addBtn.querySelector('svg');
            const isMenuHidden = actionMenu.classList.contains('hidden');
            if (isMenuHidden) {
                 icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />`;
            } else {
                 icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />`;
            }
        }

        addBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            actionMenu.classList.toggle('hidden');
            updateAddButtonIcon();
        });

        addBtnMobile.addEventListener('click', (e) => {
            e.stopPropagation();
            actionMenu.classList.toggle('hidden');
        });
        
        function closeActionMenu() {
            if (!actionMenu.classList.contains('hidden')) {
                actionMenu.classList.add('hidden');
                updateAddButtonIcon();
            }
        }

        function setMode(target) {
            const wasActive = target.classList.contains('active');
            
            menuItems.forEach(item => item.classList.remove('active'));

            if (wasActive) {
                modeTagContainer.classList.add('hidden');
                messageInput.placeholder = "Ask Sofia 2.0...";
            } else {
                target.classList.add('active');
                const placeholder = target.dataset.placeholder;
                const tagText = target.dataset.tagText;
                const iconHTML = target.querySelector('.flex.items-center.space-x-3 svg').outerHTML;
                
                modeTagContainer.classList.remove('hidden');
                modeTagContainer.classList.add('flex');
                modeTag.classList.toggle('bg-blue-100', true); // Add background for closable tag
                removeModeTagBtn.classList.remove('hidden');

                messageInput.placeholder = placeholder;
                modeTagText.textContent = tagText;
                modeTagIcon.innerHTML = iconHTML;

                if (target.dataset.mode === 'image') {
                    messageInput.value = "A photorealistic image of ";
                } else {
                    messageInput.value = "";
                }
            }
            adjustTextareaHeight();
            messageInput.dispatchEvent(new Event('input')); 
            messageInput.focus();
            closeActionMenu();
        }

        menuItems.forEach(item => {
            item.addEventListener('click', (e) => setMode(e.currentTarget));
        });

        removeModeTagBtn.addEventListener('click', () => {
            const activeItem = document.querySelector('.menu-item.active');
            if (activeItem) {
                activeItem.classList.remove('active');
            }
            modeTagContainer.classList.add('hidden');
            messageInput.placeholder = "Ask Sofia 2.0...";
            messageInput.value = "";
            adjustTextareaHeight();
            messageInput.dispatchEvent(new Event('input'));
            messageInput.focus();
        });

        menuAddFilesBtn.addEventListener('click', () => {
            fileInput.click();
            closeActionMenu();
        });
        
        document.addEventListener('click', (event) => {
            if (!actionMenu.contains(event.target) && !addBtn.contains(event.target) && !addBtnMobile.contains(event.target)) {
                closeActionMenu();
            }
        });
        
        voiceModeBtn.addEventListener('click', () => {
             addMessage("Voice mode is not yet implemented.", "system");
        });
         voiceModeBtnMobile.addEventListener('click', () => {
             addMessage("Voice mode is not yet implemented.", "system");
        });

        let recognition;
        function setupRecognition(mic) {
            if(!recognition) {
                try {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognition = new SpeechRecognition();
                    recognition.continuous = false;
                    recognition.lang = 'en-US';
                    
                    recognition.onstart = () => {
                        micBtn.classList.add('text-red-500');
                        micBtnMobile.classList.add('text-red-500');
                    }
                    recognition.onend = () => {
                         micBtn.classList.remove('text-red-500');
                         micBtnMobile.classList.remove('text-red-500');
                    }
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        messageInput.value = transcript;
                        messageInput.dispatchEvent(new Event('input'));
                        sendMessage();
                    };
                    recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        addMessage(`Speech recognition error: ${event.error}`, 'system');
                    };
                } catch (e) {
                    micBtn.style.display = 'none';
                    micBtnMobile.style.display = 'none';
                    console.warn('Speech Recognition API is not supported in this browser.');
                    return;
                }
            }
             recognition.start()
        }

        micBtn.addEventListener('click', () => setupRecognition(micBtn));
        micBtnMobile.addEventListener('click', () => setupRecognition(micBtnMobile));


        // Default to deep research mode
        setMode(document.querySelector('.menu-item[data-mode="research"]'));
        closeActionMenu();
        messageInput.dispatchEvent(new Event('input'));


    </script>
</body>
</html>

